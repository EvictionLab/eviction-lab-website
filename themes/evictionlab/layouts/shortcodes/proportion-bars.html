{{/**

Shortcode for rendering a color bar to convey a percentage/proportion

See: /ets-report-2022/index.md for usage

*/}}

{{ $title := .Get "title" }}
{{ $v1Label := .Get "v1Label" }}
{{ $v2Label := .Get "v2Label" }}

<div id="{{ .Get `id` }}" class="chart proportion-bars chart--{{ .Get `id` }}">
  <style type="text/css">
    .proportion-bars text {
      font-size: 3px;
      font-family: Gotham A, Gotham B;
      dominant-baseline: text-before-edge;
    }

    /* HACK: 2nd CSS rule gets deleted (ü§¶‚Äç‚ôÇÔ∏è hugo) */
    .proportion-bars text {}

    .proportion-bars .ticks text {
      text-anchor: middle;
      fill: #4D4D4D;
    }

    .proportion-bars .ticks text:first-of-type {
      text-anchor: start;
    }

    .proportion-bars .ticks text:last-of-type {
      text-anchor: end;
    }

    .proportion-bars .block rect {
      fill: #434878;
    }

    .proportion-bars .block rect:last-of-type {
      fill: #e24000;
    }

    .proportion-bars .blocks text {
      fill: white;
      font-size: 4px;
      dominant-baseline: central;
      text-anchor: start;
      font-weight: 600;
    }

    .proportion-bars .blocks text.v2 {
      text-anchor: end;
    }

    .proportion-bars .blocks text.label {
      fill: #444444;
      font-size: 4px;
      transform: rotate(-90deg);
      text-anchor: middle;
      dominant-baseline: text-after-edge;
      font-weight: 500;
    }

    .proportion-bars .legend text {
      font-size: 3px;
      dominant-baseline: alphabetic;
      font-weight: bold;
      text-anchor: start;
      transform: translate(20px, 0);
    }

    .proportion-bars .legend text:last-of-type {
      transform: translate(-20px, 0);
    }

    .proportion-bars .legend text .color-chip {
      fill: #434878;
      font-size: 4.5px;
    }

    .proportion-bars .legend text:last-of-type .color-chip {
      fill: #e24000;
    }

    .proportion-bars .legend text:last-of-type {
      text-anchor: end;
    }
  </style>
  {{ if $title }}
  <h3 class="chart__title">{{ $title }}</h3>
  {{ end }}
  <div id="{{ .Get `id` }}">
    <svg style="width: 100%;" viewBox="-7 0 109 81" version="1.1" xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink">
      <g class="legend">
        <text x="0" y="4">
          <tspan class="color-chip">‚ñ†</tspan>
          <tspan>{{ $v1Label }}</tspan>
        </text>
        <text x="100" y="4">
          <tspan class="color-chip">‚ñ†</tspan>
          <tspan>{{ $v2Label }}</tspan>
        </text>
      </g>
      <g class="blocks"></g>
      <g class="ticks" transform="translate(0, 76)">
        <text x="0">0%</text>
        <text x="25">25%</text>
        <text x="50">50%</text>
        <text x="75">75%</text>
        <text x="100">100%</text>
      </g>
    </svg>
  </div>
  <script>
    (() => {
    var id = {{ .Get "id" }};
    var pbCsv = {{ .Get "data" }};
    var labelField = {{ .Get "labelField" }};
    var proportionField = {{ .Get "proportionField" }};
    var v1Field = {{ .Get "v1Field" }};
    var v2Field = {{ .Get "v2Field" }};
    var vFormat = {{ .Get "vFormat" }};
    var barHeight = 20;
    var barGap = 2;
    var currentOffset = 10;
    var getBlock = ({ label, v1, v2, proportion }) => `
    <g class="block" transform="translate(0, ${currentOffset})">
      <rect y="0" height="${barHeight}" x="0" width="${proportion}" />
      <rect y="0" height="${barHeight}" x="${proportion}" width="${100 - proportion}" />
      <text class="v1" x="5" y="${barHeight / 2}">${v1}</text>
      <text class="v2" x="95" y="${barHeight / 2}">${v2}</text>
      <text class="label" x="${-barHeight / 2}" y="-1">${label}</text>
    </g>
  `
    window.addEventListener('load', function () {
      var $el = $("#" + id);
      d3.csv(pbCsv, function (data) {
        var blocks = data.
          forEach(r => {
            var block = getBlock({
              label: r[labelField],
              proportion: parseInt(r[proportionField]),
              v1: d3.format(vFormat)(r[v1Field]),
              v2: d3.format(vFormat)(r[v2Field]),
            })
            $el.find(".blocks").append(block)
            currentOffset += (barHeight + barGap)
          })
        $el.find(".ticks").attr("transform", `translate(0, ${currentOffset})`)
        $el.find("svg").attr("viewBox", `-7 0 109 ${currentOffset + 5}`)
        $el.html($el.html());
      })
    });
  }) ();
  </script>
</div>