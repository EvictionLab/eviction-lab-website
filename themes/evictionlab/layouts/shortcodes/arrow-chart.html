{{/**

Shortcode for rendering a chart of arrows conveying up/down shifts.
Gets a different viewbox on if page loads narrower than the mobileCutoff (default of 600px)
(text-sizing gets bumped to take up a greater portion of the figure's width, for legibility on smaller screens).

scaleFactor: to "zoom in" on a segment of the x-axis without having to change the viewbox and manually adjust all the
svg coordinates to maintain proper scaling. eg a scaleFactor of 5 would create an x axis going from 0-20 with ticks at 5
(25/5), 10, 15, and 20, without altering the proportions of the generic 0-100 axis. note that the tick values will be
divided this factor, so it may be simplest to use a multiple of 5 (and set a manual xMax if desired). (a more intuitive
solution would've been not to set any absolute px sizes and normalize everything based on the x extents, but this was a
simpler adaptation.)

See: /the-growing-risk-of-eviction-in-the-suburbs/index.md for usage

*/}}

{{ $title := .Get "title" }}
{{ $xMax := .Get "xMax" }}
{{ $axisLabelText := .Get "axisLabelText" }}
{{ $variant := .Get "variant" }}

<div class="chart chart--arrow chart--{{ .Get `id` }} {{ if $variant }}{{ $variant }}-variant{{ end }}">
  <style type="text/css">
    .arrow-chart__body text {
      font-size: 2.25px;
      font-family: Akkurat-Regular, sans-serif;
      dominant-baseline: middle;
    }

    /* HACK: 2nd CSS rule gets deleted (ü§¶‚Äç‚ôÇÔ∏è hugo) */
    .arrow-chart__body.is-mobile text {}

    .arrow-chart__body.is-mobile text {
      font-size: 3.5px;
    }

    .arrow-chart__body .chart-row rect {
      fill: #E6EFF4;
    }
    
    .arrow-chart__body .chart-row.odd rect {
      fill: #F4F7F9;
    }

    .arrow-chart__body .chart-row.highlighted rect {
      fill: #c6e0bf;
      fill: #2c89803b;
    }

    .arrow-chart__body .axis-lines line,
    .arrow-chart__body .tick-lines line {
      stroke: white;
      stroke-width: 0.25;
    }

    .arrow-chart__body text.name {
      text-anchor: end;
      dominant-baseline: text-before-edge;
      transform: translate(-3px, 1px);
    }

    .arrow-chart__body .arrow line {
      stroke: #aaa;
      stroke-width: .3;
    }

    .chart:not(.lollipop-variant) .arrow-chart__body .arrow line {
      stroke: #434878;
      marker-end: url(#arrowhead-dec);
    }

    #arrowhead-dec {
      stroke: #434878;
    }

    .chart:not(.lollipop-variant) .arrow-chart__body .arrow.inc line {
      stroke: #E24000;
      marker-end: url(#arrowhead-inc);
    }

    #arrowhead-inc {
      stroke: #E24000;
    }

    .arrow-chart__body .arrowhead {
      fill: none;
    }

    .arrow-chart__body .arrow line {
      transform: translate(0, -0.1px);
    }
    .arrow-chart__body .arrow .row-value.right {
      transform: translate(2px, 0);
      text-anchor: start;
    }

    .arrow-chart__body .arrow .row-value.left {
      transform: translate(-2px, 0);
      text-anchor: end;
    }

    .lollipop-variant circle {
      stroke-width: 0.2;
      fill-opacity: 0.7;
    }
    .lollipop-variant .chart-row:hover circle {
      fill-opacity: 0.9;
    }

    .lollipop-variant circle.before {
      stroke: #434878;
      fill: #434878;
    }
    
    .lollipop-variant circle.after {
      stroke: #E24000;
      fill: #E24000;
    }

    .arrow-chart__body .chart-row:not(.highlighted) text.row-value {
      display: none;
    }

    .arrow-chart__body .chart-row:hover text.row-value {
      display: block;
    }

    .arrow-chart__body .tick-values text {
      text-anchor: middle;
      dominant-baseline: text-before-edge;
    }

    .arrow-chart__body .tick-values text:first-of-type {
      text-anchor: start;
    }

    .arrow-chart__body .tick-values text:last-of-type {
      text-anchor: end;
    }
    .arrow-chart__body.is-mobile .tick-values text:last-of-type {
      transform: translate(-1px, 0);
    }

    .arrow-chart__body .axis-title {
      text-anchor: middle;
      transform: translate(0, 8px);
    }
    .arrow-chart__body.is-mobile .axis-title {
      transform: translate(0, 12px);
    }
    .arrow-chart__body .legend-desc {
      transform: translate(0, 14px);
    }
    .arrow-chart__body.is-mobile .legend-desc {
      transform: translate(0, 22px);
    }
    
    .arrow-chart__body .legend-desc text {
      text-transform: uppercase;
      font-family: GT-Eesti-Display-Medium, sans-serif;
    }

    .arrow-chart__body .arrow-chart {
      display: block;
    }

    .arrow-chart__body .sticky-leg {
      background: #F4F7F9;
      opacity: 0.93;
      position: sticky;
      bottom: 0;
      left: 0;
    }

    .lollipop-variant .legend-desc .arrow.inc circle.before,
    .lollipop-variant .legend-desc .arrow:not(.inc) circle.after,
    .lollipop-variant .legend-desc .arrow line {
      display: none;
    }

    .arrow-chart__body {
      height: 100% !important;
    }
  </style>
  {{ if $title }}
  <h3 class="chart__title">{{ $title }}</h3>
  {{ end }}
  <div id="{{ .Get `id` }}" class="arrow-chart__body">
    <svg class="arrow-chart" viewBox="0 0 0 0" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <marker id="arrowhead-inc" class="arrowhead" markerWidth="10" markerHeight="10" refY="5" orient="auto" refX="10">
          <polyline points="0 0, 10 5, 0 10"></polyline>
        </marker>
        <marker id="arrowhead-dec" class="arrowhead" markerWidth="10" markerHeight="10" refY="5" orient="auto" refX="10">
          <polyline points="0 0, 10 5, 0 10"></polyline>
        </marker>
      </defs>
      <g class="rows"></g>
    </svg>
    <svg class="sticky-leg" viewBox="0 0 0 0" xmlns="http://www.w3.org/2000/svg">
      <g class="tick-lines xMax-dependent">
        <line data-val="0" x1="0" x2="0" y1="0" y2="1.2"></line>
        <line data-val="25" x1="25" x2="25" y1="0" y2="1.2"></line>
        <line data-val="50" x1="50" x2="50" y1="0" y2="1.2"></line>
        <line data-val="75" x1="75" x2="75" y1="0" y2="1.2"></line>
        <line data-val="100" x1="100" x2="100" y1="0" y2="1.2"></line>
        <line data-val="125" x1="125" x2="125" y1="0" y2="1.2"></line>
        <line data-val="150" x1="150" x2="150" y1="0" y2="1.2"></line>
        <line data-val="175" x1="175" x2="175" y1="0" y2="1.2"></line>
        <line data-val="200" x1="200" x2="200" y1="0" y2="1.2"></line>
        <line data-val="225" x1="225" x2="225" y1="0" y2="1.2"></line>
        <line data-val="250" x1="250" x2="250" y1="0" y2="1.2"></line>
        <line data-val="275" x1="275" x2="275" y1="0" y2="1.2"></line>
        <line data-val="300" x1="300" x2="300" y1="0" y2="1.2"></line>
      </g>
      <g class="tick-values xMax-dependent scaleFactor-dependent" transform="translate(0, 2)">
        <text data-val="0" x="0">0%</text>
        <text data-val="25" x="25">25%</text>
        <text data-val="50" x="50">50%</text>
        <text data-val="75" x="75">75%</text>
        <text data-val="100" x="100">100%</text>
        <text data-val="125" x="125">125%</text>
        <text data-val="150" x="150">150%</text>
        <text data-val="175" x="175">175%</text>
        <text data-val="200" x="200">200%</text>
        <text data-val="225" x="225">225%</text>
        <text data-val="250" x="250">250%</text>
        <text data-val="275" x="275">275%</text>
        <text data-val="300" x="300">300%</text>
      </g>
      <text class="axis-title" x="50"></text>
      <g class="legend-desc"></g>
    </svg>
  </div>

  <script>
    // immediately invoked function so that we don't pollute the global scope
    // (variables overwrite those in other component script tags)
  (() => {
    var id = {{ .Get "id" }};
    var csv = {{ .Get "data" }};
    var xMax = {{ .Get "xMax" }} || 100;
    var scaleFactor = {{ .Get "scaleFactor" }} || 1;
    var xMinMobile = {{ .Get "xMinMobile" }} || -42;
    var xMinDesktop = {{ .Get "xMinDesktop" }} || -30;
    var rHeight = {{ .Get "rowHeight" }};
    var mobileCutoff = {{ .Get "mobileCutoff" }} || 600;
    var legendDecArrowText = {{ .Get "legendDecArrowText" }} || "";
    var legendIncArrowText = {{ .Get "legendIncArrowText" }} || "";
    var legendLabelText = {{ .Get "legendLabelText" }} || "";
    var axisLabelText = {{ .Get "axisLabelText" }} || "";
    var isLollipop = {{ .Get "variant" }} === "lollipop";
    var nameCol = {{ .Get "nameCol" }} || "metro";
    var beforeCol = {{ .Get "beforeCol" }} || "before";
    var afterCol = {{ .Get "afterCol" }} || "after";
    var isPercentValue = {{ .Get "isPercent" }}
    var isPercent = String(isPercentValue) !== "false";

    var format = isPercent ? '.1%' : '';
    
    window.addEventListener('load', function () {
      var $el = $("#" + id);
      
      var isMobile = window.innerWidth <= Number(mobileCutoff);
      const rowHeight = rHeight
        ? rHeight
        : isMobile
          ? 6
          : 4.5;
      const xMin = isMobile ? xMinMobile : xMinDesktop;

      const $rows = $el.find('.arrow-chart g.rows')
      const $arrows = $el.find('.arrow-chart g.arrows')

      const getRowValue = ({ content, classes = "", dx }) => `
        <text class="row-value ${classes}" ${dx && `dx="${dx}"`}>
          ${content}
        </text>
      `

      const getArrow = ({ before, after, yOffset = 0, valueContent = '', beforeContent = '', afterContent = '', displayRight = false }) => {
        const shift = after - before
        let arrowClass = "arrow"
        if (before < after) arrowClass += " inc"

        let shapes = "";
        let rowValues = "";
        if (isLollipop) {
          shapes = `
<circle class="before" r="1" cy="-0.1" />
<circle class="after" r="1" cy="-0.1" cx="${shift}" />
`         
          const beforeRowValue = getRowValue({
            content: beforeContent || d3.format(format)(before / (isPercent ? 100 : 1) / scaleFactor),
            classes: shift > 0 ? "left" : "right",
          });
          const afterRowValue = getRowValue({
            content: afterContent || d3.format(format)(after / (isPercent ? 100 : 1) / scaleFactor),
            classes: shift > 0 ? "right" : "left",
            dx: shift
          });
          rowValues = `${beforeRowValue}${afterRowValue}`
        } else {
        // make room for size of arrow head
        let valueOffset = Math.abs(shift) < 3.5
          ? (3.5 - Math.abs(shift)) * Math.sign(shift * -1)
          : 0;
        if (displayRight && shift > 0) {
          valueOffset = shift;
        }
          rowValues = getRowValue({
            content: valueContent || d3.format(format)(shift / (isPercent ? 100 : 1) / scaleFactor),
            classes: displayRight || shift < 0 ? "right" : "left",
            dx: valueOffset
          });
        }

        return `
<g class="${arrowClass}" transform="translate(${before}, ${yOffset})">
  <line x1="0" y1="0" x2="${shift}" y2="0" />
  ${shapes}
  ${rowValues}
</g>
`
      }
      
      d3.csv(csv, function (data) {
        data.
          map((r, i) => {
            const before = parseFloat(r[beforeCol]) * (isPercent ? 100 : 1) * scaleFactor;
            const after = parseFloat(r[afterCol]) * (isPercent ? 100 : 1) * scaleFactor;
            return {
              name: r[nameCol],
              highlighted: !!r.highlighted && r.highlighted !== "false",
              before,
              after,
            }
          })
          .sort((a, b) => b.after - a.after)
          .forEach((r, i) => {
            const y = rowHeight * i;
            let rowClasses = "chart-row"
            if (r.highlighted) rowClasses += " highlighted"
            if (!(i % 2)) rowClasses += " odd"
            const axisLines = `
  <g class="axis-lines xMax-dependent">
    <line data-val="0" x1="0" x2="0" y1="0" y2="${rowHeight}"></line>
    <line data-val="25" x1="25" x2="25" y1="0" y2="${rowHeight}"></line>
    <line data-val="50" x1="50" x2="50" y1="0" y2="${rowHeight}"></line>
    <line data-val="75" x1="75" x2="75" y1="0" y2="${rowHeight}"></line>
    <line data-val="100" x1="100" x2="100" y1="0" y2="${rowHeight}"></line>
    <line data-val="125" x1="125" x2="125" y1="0" y2="${rowHeight}"></line>
    <line data-val="150" x1="150" x2="150" y1="0" y2="${rowHeight}"></line>
    <line data-val="175" x1="175" x2="175" y1="0" y2="${rowHeight}"></line>
    <line data-val="200" x1="200" x2="200" y1="0" y2="${rowHeight}"></line>
    <line data-val="200" x1="200" x2="200" y1="0" y2="${rowHeight}"></line>
    <line data-val="225" x1="225" x2="225" y1="0" y2="${rowHeight}"></line>
    <line data-val="250" x1="250" x2="250" y1="0" y2="${rowHeight}"></line>
    <line data-val="275" x1="275" x2="275" y1="0" y2="${rowHeight}"></line>
    <line data-val="300" x1="300" x2="300" y1="0" y2="${rowHeight}"></line>
  </g>
`
            const rowWrapper = `
<g class="${rowClasses}" transform="translate(0, ${y})">
  <rect x="${xMin}" y="0" height="${rowHeight}" width="100%" width="100%" height="${rowHeight}" />
  ${axisLines}
  <text class="name" x="0" y="0">${r.name}</text>
  ${getArrow({ ...r, yOffset: rowHeight / 2 + 0.1, includeTooltip: true })}
</g>
          `
            $rows.append(rowWrapper)
          })

        // create legend
        const startX = isMobile ? xMin + 12 : 0;
        const arrowLength = 7;
        const decBefore = isMobile ? 27 : 40;
        const incBefore = isMobile ? 55 : 60;
        const labelText = !legendLabelText ? "" : legendLabelText + ":";
        const decArrow = !legendDecArrowText
          ? ""
          : getArrow({
            before: decBefore,
            after: decBefore - arrowLength,
            valueContent: legendDecArrowText,
            beforeContent: legendDecArrowText,
            afterContent: " ", // overwrite the numeric value
            displayRight: true
          });
        const incArrow = !legendIncArrowText
          ? ""
          : getArrow({
            before: incBefore,
            after: incBefore + arrowLength,
            valueContent: legendIncArrowText,
            beforeContent: " ", // overwrite the numeric value
            afterContent: legendIncArrowText,
            displayRight: true
          });
        const legendLabel = `
        <text x="${startX}">${labelText}</text>
        ${decArrow}
        ${incArrow}
        `
        $el.find(".legend-desc").append(legendLabel)
        axisLabelText && $el.find(".axis-title").append(axisLabelText)

        const viewBoxChart = `${xMin} 0 ${xMax - xMin} ${data.length * rowHeight}`
        const viewBoxLegend = `${xMin} 0 ${xMax - xMin} ${isMobile ? 30 : 20}`
        $el.find(".arrow-chart").attr("viewBox", viewBoxChart)
        $el.find(".sticky-leg").attr("viewBox", viewBoxLegend)
        $el.toggleClass("is-mobile", isMobile)

        $el.find('.xMax-dependent [data-val]').each((i, el) => {
          if (parseInt(el.dataset.val) > xMax) {
            // xMax-dependent elements only get rendered if their val is relevant to the arrow
            // chart being created (eg if scale is 0-100, elements for values > 100 get removed)
            el.remove()
          }
        })
        if (scaleFactor !== 1 || !isPercent) {
          $el.find('.scaleFactor-dependent [data-val]').each((i, el) => {
            // elements only get rendered if their val is relevant to the arrow
            // chart being created (eg if scale is 0-100, elements for values > 100 get removed)
            el.textContent = el.dataset.val / scaleFactor + (isPercent ? "%" : "")
          })
        }

        $el.html($el.html());
      })
    });
    }) ();
  </script>
</div>