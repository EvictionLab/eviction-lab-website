{{ $rentersSite := .Page.Params.rentersSite }}
<div class="intro">
  <div class="layout">
    <div class="intro__content">
      <h1 class="intro__heading">
        <a id="top">{{ .Page.Params.h1 }}</a>
      </h1>
      <!-- {{ range $index, $element := .Site.Data.renter_hhs_by_state }}
        {{ if eq $rentersSite $element.site }}
          <h3 class="intro__renter-population mx-auto">RENTER HOUSEHOLDS: {{ $element.estimate }}</h3>
        {{ end }}
      {{ end }}
      {{ range $index, $element := .Site.Data.renter_hhs_by_city }}
        {{ if eq $rentersSite $element.site }}
          <h3 class="intro__renter-population mx-auto">RENTER HOUSEHOLDS: {{ $element.estimate }}</h3>
        {{ end }}
      {{ end }} -->
      <div id="introText" class="intro__text">{{ .Inner | markdownify }}</div>
    </div>
    <div id="introStatsWrapper" class="intro__stats-wrapper">
      <div class="major-stats"></div>
      <div class="minor-stats"></div>
    </div>
  </div>

  <script>
    var site = {{ .Get "site" }}
    window.addEventListener('load', function () {

      var statFiles = [
        { id: "filing", url: "/uploads/filing_data_by_site.csv" },
        { id: "basic", url: "/uploads/basic_data_by_site.csv" },
        { id: "acs", url: "/uploads/acs_data_by_site.csv" },
      ]
      var stats = [
        {
          file: 'filing',
          field: 'filings_pandemic',
          display: 'filings total',
          formatter: d3.format(','),
          isMajor: true,
        },
        {
          file: 'filing',
          field: 'filings_past_year',
          display: 'filings in the past year',
          formatter: d3.format(','),
          isMajor: true,
        },
        {
          file: 'filing',
          field: 'filings_past_month',
          display: 'filings in the past month',
          formatter: d3.format(','),
          isMajor: true,
        },
        {
          file: 'filing',
          field: 'serial_share',
          display: 'serial filings',
          tooltip: 'Repeated filings against the same household at the same address in the last 12 months',
          formatter: d3.format('.0%'),
          isMajor: true,
        },
        {
          file: 'acs',
          field: 'renter_hh',
          display: 'renter households',
          formatter: d3.format(',')
        },
        {
          file: 'acs',
          field: 'median_rent',
          display: 'median rent',
          formatter: d3.format('$,')
        },
        {
          file: 'basic',
          field: 'historical_efr',
          display: 'historical efr (national db)',
          // formatter: d3.format(',')
        },
        {
          file: 'basic',
          field: 'notice_requirement',
          display: 'notice requirement',
          formatter: v => !!v ? (v + ' days') : 'N/A'
        },
        {
          file: 'basic',
          field: 'avg_filing_fee',
          display: 'average filing fee',
          formatter: d3.format('$,')
        },
        {
          file: 'basic',
          field: 'historical_baseline_years',
          display: 'baseline years for which we have data',
          // formatter: d3.format(',')
        },
        {
          file: 'basic',
          field: 'borders',
          display: 'county coverage',
          // formatter: d3.format(',')
        },
      ]
//       loadAll(statFiles, {}, dataMap => {
//         var wrapper = $("#introStatsWrapper")
//         stats.forEach(s => {
//           var parentDiv = s.isMajor ? 'major-stats' : 'minor-stats'
//           var el = wrapper.find('.' + parentDiv)
//           var row = dataMap[s.file].find(d => d.site === site)
//           var val = row && row[s.field]
//           if (!!val) {
//             var tt = !s.tooltip
//               ? ''
//               : `<span class="inline-tooltip">(?)
//   <span class="tooltiptext">${s.tooltip}</span>
// </span>`
//             var fVal = s.formatter ? s.formatter(val) : val
//             el.append('<dl class="highlighted-stat"><dd>' + fVal + '</dd><dt>' + s.display + tt + '</dt></dl>')
//           }
//         })
//         wrapper.css('opacity', 1)
//       })

      var getVal = (fileData, s) => {
        var row = fileData.find((d) => d.site === site);
        return row ? row[s.field] : null;
      }

      var getContainer = (wrapper, stat) => wrapper.find(stat.isMajor ? '.major-stats' : '.minor-stats')

      Elab.Utils.createStatBlock('#introStatsWrapper', statFiles, stats, getVal, getContainer)
      Elab.Utils.createTwitterLink('.share__link--twitter')
      Elab.Utils.createFacebookLink('.share__link--facebook')
      var dateFormat = d3.timeFormat("%b %e, %Y")
      var cdcMoratorium = Elab.Utils.getCdcMoratoriumRange().map(function(d) {
        return dateFormat(d)
      }).join(' - ')
      $('#cdcGuidelines').text(cdcMoratorium)
    })
  </script>
</div>
