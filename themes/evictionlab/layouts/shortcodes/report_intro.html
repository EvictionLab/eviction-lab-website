{{ $rentersSite := .Page.Params.rentersSite }}
<div class="intro">
  <div class="layout">
    <div class="intro__content">
      <h1 class="intro__heading">
        <a id="top">{{ .Page.Params.h1 }}</a>
      </h1>
      {{ range $index, $element := .Site.Data.renter_hhs_by_state }}
        {{ if eq $rentersSite $element.site }}
          <h3 class="intro__renter-population mx-auto">RENTER HOUSEHOLDS: {{ $element.estimate }}</h3>
        {{ end }}
      {{ end }}
      {{ range $index, $element := .Site.Data.renter_hhs_by_city }}
        {{ if eq $rentersSite $element.site }}
          <h3 class="intro__renter-population mx-auto">RENTER HOUSEHOLDS: {{ $element.estimate }}</h3>
        {{ end }}
      {{ end }}
      <div id="introText" class="intro__text">{{ .Inner | markdownify }}</div>
    </div>
    <div id="introStatsWrapper" class="intro__stats-wrapper">
      <div class="intro__stats-stat filings_pandemic">
        <h3></h3>
        <p>filings total</p>
      </div>
      <div class="intro__stats-stat filings_past_year">
        <h3></h3>
        <p>filings in the past year</p>
      </div>
      <div class="intro__stats-stat filings_past_month">
        <h3></h3>
        <p>filings in the past month</p>
      </div>
    </div>
    
    <div id="introSnapshotWrapper" class="intro__snapshot-wrapper">
      <dl class="intro__snapshot-stat renter_hh"></dl>
      <dl class="intro__snapshot-stat median_rent"></dl>
      <dl class="intro__snapshot-stat historical_efr"></dl>
      <dl class="intro__snapshot-stat notice_requirement"></dl>
      <dl class="intro__snapshot-stat avg_filing_fee"></dl>
      <dl class="intro__snapshot-stat historical_baseline_years"></dl>
      <dl class="intro__snapshot-stat borders"></dl>
    </div>
  </div>

  <script>
                      var statsUrl = "/uploads/filing_data_by_site.csv"
        var site = {{ .Get "site" }}

    window.addEventListener('load', function() {
      var snapshotFiles = {
        basic: "/uploads/basic_data_by_site.csv",
        acs: "/uploads/acs_data_by_site.csv",
      }
      var snapshotFigures = [
        {
          file: 'acs',
          field: 'renter_hh',
          display: 'Renter households',
          formatter: d3.format(',')
        },
        {
          file: 'acs',
          field: 'median_rent',
          display: 'Median rent',
          formatter: d3.format('$,')
        },
        {
          file: 'basic',
          field: 'historical_efr',
          display: 'Historical EFR(national DB)',
          // formatter: d3.format(',')
        },
        {
          file: 'basic',
          field: 'notice_requirement',
          display: 'Notice requirement',
          formatter: v => !!v ? (v + ' days') : 'N/A'
        },
        {
          file: 'basic',
          field: 'avg_filing_fee',
          display: 'Avg filing fee',
          formatter: d3.format('$,')
        },
        {
          file: 'basic',
          field: 'historical_baseline_years',
          display: 'baseline years for which we have data',
          // formatter: d3.format(',')
        },
        {
          file: 'basic',
          field: 'borders',
          display: 'Delineate borders(county coverage)',
          // formatter: d3.format(',')
        },
      ]
      var snapshotCallback = function (acsData) {
        Elab.Data.loadData(snapshotFiles.basic, d => d, function (basicData) {
          var data = {
            acs: acsData,
            basic: basicData,
          }

          var wrapper = $("#introSnapshotWrapper")
          snapshotFigures.forEach(f => {
            var el = wrapper.find('.' + f.field)
            var row = data[f.file].find(d => d.site === site)
            var val = row && row[f.field]
            el.append('<dt>' + f.display + '</dt>')
            el.append('<dd>' + (f.formatter ? f.formatter(val) : val) + '</dd>')
          })
        })
      }
      Elab.Data.loadData(snapshotFiles.acs, d => d, snapshotCallback)

      // console.log(876, { statsUrl })
      var statsCallback = function (data) {
        // console.log(234, { data })
        var row = data.find(d => d.site === site)

        if (!!row) {
          var el = $("#introStatsWrapper")
          el.css('opacity', 1)
          var stats = ["filings_pandemic",
            "filings_past_year",
            "filings_past_month",]
          stats.forEach(s => el.find('.' + s + ' h3').text(d3.format(',')(row[s])))
        }
      }
      Elab.Data.loadData(statsUrl, d => d, statsCallback)

      Elab.Utils.createTwitterLink('.share__link--twitter')
      Elab.Utils.createFacebookLink('.share__link--facebook')
      var dateFormat = d3.timeFormat("%b %e, %Y")
      var cdcMoratorium = Elab.Utils.getCdcMoratoriumRange().map(function(d) {
        return dateFormat(d)
      }).join(' - ')
      $('#cdcGuidelines').text(cdcMoratorium)
    })
  </script>
</div>
