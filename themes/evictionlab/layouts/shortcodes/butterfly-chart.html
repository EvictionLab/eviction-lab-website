{{/**

Shortcode for rendering a butterfly chart, generic form of a population pyramid (adapted from horizontal-bars).


*/}}

{{ $title := .Get "title" }}
{{ $xMax := .Get "xMax" }}
{{ $axisLabelText := .Get "axisLabelText" }}
{{ $axisLabelX := .Get "axisLabelX" }}

<div class="chart chart--hbar chart--{{ .Get `id` }}">
  <style type="text/css">
    .hbar-chart__body text {
      font-size: 2.25px;
      font-family: GT-Eesti-Display-Bold, GT Eesti Display, sans-serif;
      dominant-baseline: middle;
      text-transform: uppercase;
      fill: #434878;
    }

    /* HACK: 2nd CSS rule gets deleted (ü§¶‚Äç‚ôÇÔ∏è hugo) */
    .hbar-chart__body.is-mobile text {}

    .hbar-chart__body.is-mobile text {
      font-size: 3.5px;
    }

    .hbar-chart__body.is-mobile .tick-values text {
      font-family: GT-Eesti-Display-Medium, GT Eesti Display, sans-serif;
      fill: #7d7d7d;
    }

    .hbar-chart__body .chart-row rect {
      fill: #E6EFF4;
    }

    .hbar-chart__body .chart-row.odd rect {
      fill: #F4F7F9;
    }

    .hbar-chart__body .chart-row.highlighted rect {
      fill: #c6e0bf;
      fill: #2c89803b;
    }

    .hbar-chart__body .axis-lines line,
    .hbar-chart__body .tick-lines line {
      stroke: white;
      stroke-width: 0.25;
    }

    .hbar-chart__body text.name {
      text-anchor: end;
      dominant-baseline: text-before-edge;
      transform: translate(-3px, 1px);
    }

    .hbar-chart__body .hbar line {
      stroke: #434878;
      stroke-width: 4;
    }

    .hbar-chart__body .hbar:not(.left) .legend-text {
      text-anchor: end;
    }

    .hbar-chart__body .hbar.inc line {
      stroke: #E24000;
    }

    .hbar-chart__body .hbar line {
      transform: translate(0, -0.1px);
    }

    .hbar-chart__body .hbar .row-value,
    .hbar-chart__body .legend-desc .hbar.inc .row-value {
      transform: translate(2px, .35px);
      text-anchor: start;
      color: white;
    }

    .hbar-chart__body .hbar.left .row-value {
      transform: translate(-2px, .35px);
      text-anchor: end;
    }

    .hbar-chart__body .chart-row:not(.highlighted) text.row-value {
      display: none;
    }

    .hbar-chart__body .chart-row:hover g.hbar line {
      stroke: var(--c1);
    }

    .hbar-chart__body .chart-row:hover text.row-value {
      display: block;
    }

    .hbar-chart__body .tick-values text {
      text-anchor: middle;
      dominant-baseline: text-before-edge;
    }

    .hbar-chart__body .tick-values text:first-of-type {
      text-anchor: start;
    }

    .hbar-chart__body .tick-values text:last-of-type {
      text-anchor: end;
    }

    .hbar-chart__body.is-mobile .tick-values text:last-of-type {
      transform: translate(-1px, 0);
    }

    .hbar-chart__body .axis-title {
      text-anchor: middle;
      transform: translate(0, 8px);
    }

    .hbar-chart__body.is-mobile .axis-title {
      transform: translate(0, 12px);
    }

    .hbar-chart__body .legend-desc {
      transform: translate(0, 14px);
    }

    .hbar-chart__body.is-mobile .legend-desc {
      transform: translate(0, 22px);
    }

    .hbar-chart__body .legend-desc text {
      text-transform: uppercase;
      font-family: GT-Eesti-Display-Medium, sans-serif;
    }

    .hbar-chart__body .hbar-chart {
      display: block;
    }

    .hbar-chart__body .sticky-leg {
      background: #F4F7F9;
      opacity: 0.93;
      position: sticky;
      bottom: 0;
      left: 0;
    }

    .hbar-chart__body {
      height: 100% !important;
    }
  </style>
  {{ if $title }}
  <h3 class="chart__title">{{ $title }}</h3>
  {{ end }}
  <div id="{{ .Get `id` }}" class="hbar-chart__body">
    <svg class="hbar-chart" viewBox="0 0 0 0" xmlns="http://www.w3.org/2000/svg">
      <g class="rows"></g>
    </svg>
    <svg class="sticky-leg" viewBox="0 0 0 0" xmlns="http://www.w3.org/2000/svg">
      <g class="tick-lines xMax-dependent">
        <line data-val="200" x1="-200" x2="-200" y1="0" y2="1.2"></line>
        <line data-val="175" x1="-175" x2="-175" y1="0" y2="1.2"></line>
        <line data-val="150" x1="-150" x2="-150" y1="0" y2="1.2"></line>
        <line data-val="125" x1="-125" x2="-125" y1="0" y2="1.2"></line>
        <line data-val="100" x1="-100" x2="-100" y1="0" y2="1.2"></line>
        <line data-val="75" x1="-75" x2="-75" y1="0" y2="1.2"></line>
        <line data-val="50" x1="-50" x2="-50" y1="0" y2="1.2"></line>
        <line data-val="25" x1="-25" x2="-25" y1="0" y2="1.2"></line>
        <line data-val="0" x1="0" x2="0" y1="0" y2="1.2"></line>
        <line data-val="25" x1="25" x2="25" y1="0" y2="1.2"></line>
        <line data-val="50" x1="50" x2="50" y1="0" y2="1.2"></line>
        <line data-val="75" x1="75" x2="75" y1="0" y2="1.2"></line>
        <line data-val="100" x1="100" x2="100" y1="0" y2="1.2"></line>
        <line data-val="125" x1="125" x2="125" y1="0" y2="1.2"></line>
        <line data-val="150" x1="150" x2="150" y1="0" y2="1.2"></line>
        <line data-val="175" x1="175" x2="175" y1="0" y2="1.2"></line>
        <line data-val="200" x1="200" x2="200" y1="0" y2="1.2"></line>
      </g>
      <g class="tick-values xMax-dependent scaleFactor-dependent" transform="translate(0, 2)">
        <text data-val="200" x="-200">200%</text>
        <text data-val="175" x="-175">175%</text>
        <text data-val="150" x="-150">150%</text>
        <text data-val="125" x="-125">125%</text>
        <text data-val="100" x="-100">100%</text>
        <text data-val="75" x="-75">75%</text>
        <text data-val="50" x="-50">50%</text>
        <text data-val="25" x="-25">25%</text>
        <text data-val="0" x="0">0%</text>
        <text data-val="25" x="25">25%</text>
        <text data-val="50" x="50">50%</text>
        <text data-val="75" x="75">75%</text>
        <text data-val="100" x="100">100%</text>
        <text data-val="125" x="125">125%</text>
        <text data-val="150" x="150">150%</text>
        <text data-val="175" x="175">175%</text>
        <text data-val="200" x="200">200%</text>
      </g>
      <text class="axis-title" x="{{ $axisLabelX }}"></text>
      <g class="legend-desc"></g>
    </svg>
  </div>

  <script>
    // immediately invoked function so that we don't pollute the global scope
    // (variables overwrite those in other component script tags)
    (() => {
    var id = {{ .Get "id" }}
    var hbCsv = {{ .Get "data" }}
    var xMax = {{ .Get "xMax" }} || 100;
    var scaleFactor = {{ .Get "scaleFactor" }} || 1;
    var nameX = {{ .Get "nameX" }} || 0;
    var barGap = {{ .Get "barGap" }} || 0;
    var xMinMobile = {{ .Get "xMinMobile" }} || -42;
    var xMinDesktop = {{ .Get "xMinDesktop" }} || -30;
    var mobileCutoff = {{ .Get "mobileCutoff" }} || 600;
    var nameField = {{ .Get "nameField" }};
    var numerator1Field = {{ .Get "numerator1Field" }};
    var numerator2Field = {{ .Get "numerator2Field" }};
    var denominatorField = {{ .Get "denominatorField" }};
    var legendLabelText = {{ .Get "legendLabelText" }} || "";
    var axisLabelText = {{ .Get "axisLabelText" }} || "";
    var legendLeftText = {{ .Get "legendLeftText" }} || "";
    var legendRightText = {{ .Get "legendRightText" }} || "";

    window.addEventListener('load', function () {
      var $el = $("#" + id);

      var isMobile = window.innerWidth <= Number(mobileCutoff);
      const rowHeight = isMobile ? 6 : 4.5;
      const xMin = isMobile ? xMinMobile : xMinDesktop;

      const $rows = $el.find('.hbar-chart g.rows')

      const getBar = ({ value, yOffset = 0, valueContent = '', leftBar, legendText }) => {
        if (isNaN(value)) return '';
        const width = value * scaleFactor;
        let barClass = "hbar"
        if (leftBar) barClass += " left"
        const content = valueContent ||
          d3.format('.1%')(Math.abs(width) / 100 / scaleFactor);
        const valueVal = `
  <text dx="${width}" class="row-value">
    ${content}
  </text>
          `
        const legendItem = legendText && `
  <text dx="${50 * Math.sign(width)}" class="legend-text">
    ${legendText}
  </text>
          `

        return `
<g class="${barClass}" transform="translate(0, ${yOffset})">
  <line x1="${barGap * Math.sign(width)}" y1="0" x2="${width}" y2="0" />
  ${valueVal}
  ${legendItem}
</g>
`
      }

      d3.csv(hbCsv, function (data) {
        data.
          map(r => {
            const numerator1 = parseFloat(r[numerator1Field]);
            const numerator2 = parseFloat(r[numerator2Field]);
            const denominator = parseFloat(r[denominatorField]) || 1;
            // console.log(r, numerator, denominator, numerator / denominator)
            return {
              name: r[nameField],
              highlighted: !!r.highlighted && r.highlighted !== "false",
              value1: numerator1 / denominator,
              value2: numerator2 / denominator,
            }
          })
          .sort((a, b) => b.value - a.value)
          .forEach((r, i) => {
            const y = rowHeight * i;
            let rowClasses = "chart-row"
            if (r.highlighted) rowClasses += " highlighted"
            if (!(i % 2)) rowClasses += " odd"

            const axisLines = `
  <g class="axis-lines xMax-dependent">
    <line data-val="200" x1="-200" x2="-200" y1="0" y2="${rowHeight}"></line>
    <line data-val="175" x1="-175" x2="-175" y1="0" y2="${rowHeight}"></line>
    <line data-val="150" x1="-150" x2="-150" y1="0" y2="${rowHeight}"></line>
    <line data-val="125" x1="-125" x2="-125" y1="0" y2="${rowHeight}"></line>
    <line data-val="100" x1="-100" x2="-100" y1="0" y2="${rowHeight}"></line>
    <line data-val="75" x1="-75" x2="-75" y1="0" y2="${rowHeight}"></line>
    <line data-val="50" x1="-50" x2="-50" y1="0" y2="${rowHeight}"></line>
    <line data-val="25" x1="-25" x2="-25" y1="0" y2="${rowHeight}"></line>
    <line data-val="0" x1="0" x2="0" y1="0" y2="${rowHeight}"></line>
    <line data-val="25" x1="25" x2="25" y1="0" y2="${rowHeight}"></line>
    <line data-val="50" x1="50" x2="50" y1="0" y2="${rowHeight}"></line>
    <line data-val="75" x1="75" x2="75" y1="0" y2="${rowHeight}"></line>
    <line data-val="100" x1="100" x2="100" y1="0" y2="${rowHeight}"></line>
    <line data-val="125" x1="125" x2="125" y1="0" y2="${rowHeight}"></line>
    <line data-val="150" x1="150" x2="150" y1="0" y2="${rowHeight}"></line>
    <line data-val="175" x1="175" x2="175" y1="0" y2="${rowHeight}"></line>
    <line data-val="200" x1="200" x2="200" y1="0" y2="${rowHeight}"></line>
  </g>
`
            const rowWrapper = `
<g class="${rowClasses}" transform="translate(0, ${y})">
  <rect x="${xMin}" y="0" height="${rowHeight}" width="100%" width="100%" height="${rowHeight}" />
  ${axisLines}
  <text class="name" x="${nameX}" y="0">${r.name}</text>
  ${getBar({ ...r, value: -r.value1, yOffset: rowHeight / 2 + 0.1, leftBar: true, legendText: !i && legendLeftText })}
  ${getBar({ ...r, value: r.value2, yOffset: rowHeight / 2 + 0.1, legendText: !i && legendRightText })}
</g>
          `
            $rows.append(rowWrapper)
          })

        const startX = isMobile ? xMin + 12 : 0;
        const barLength = 7;
        const decBefore = isMobile ? 27 : 40;
        const incBefore = isMobile ? 55 : 60;
        const labelText = !legendLabelText ? "" : legendLabelText + ":";

        // $(".legend-desc").append(legendLabel)
        axisLabelText && $el.find(".axis-title").append(axisLabelText);

        const viewBoxChart = `${xMin} 0 ${xMax - xMin} ${data.length * rowHeight}`
        const viewBoxLegend = `${xMin} 0 ${xMax - xMin} 15`
        $el.find(".hbar-chart").attr("viewBox", viewBoxChart);
        $el.find(".sticky-leg").attr("viewBox", viewBoxLegend);
        $el.toggleClass("is-mobile", isMobile)

        $el.find('.xMax-dependent [data-val]').each((i, el) => {
          if (parseInt(el.dataset.val) > xMax) {
            // xMax-dependent elements only get rendered if their val is relevant to the bar
            // chart being created (eg if scale is 0-100, elements for values > 100 get removed)
            el.remove()
          }
        })
        if (scaleFactor !== 1) {
          $el.find('.scaleFactor-dependent [data-val]').each((i, el) => {
            // elements only get rendered if their val is relevant to the arrow
            // chart being created (eg if scale is 0-100, elements for values > 100 get removed)
            el.textContent = el.dataset.val / scaleFactor + "%"
          })
        }

        $el.html($el.html());
      })
    });
    }) ();
  </script>
</div>